<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="preprocess">

    <select id="selectTbTaskRunByPk" parameterType="kr.go.spo.dto.TaskRunDto" resultType="kr.go.spo.dto.TaskRunDto" >
        SELECT
               PROCESS_INSTANCE_ID
             , TASK_INSTANCE_ID
             , CASE_ID
             , TASK_STATUS
             , TASK_START_TIME
             , TASK_SUSPEND_TIME
             , TASK_END_TIME
         FROM TB_TASK_RUN
        WHERE 1=1
          AND PROCESS_INSTANCE_ID = #{processInstanceId}
          AND TASK_INSTANCE_ID = #{taskInstanceId}
    </select>
    <insert id="insertTbTaskRun" parameterType="kr.go.spo.dto.TaskRunDto">
        INSERT INTO tb_task_run
        (
          process_instance_id
        , task_instance_id
        , case_id
        , task_status
        , task_start_time
        , task_suspend_time
        , task_end_time
        , update_time
        )
        VALUES
            (
              #{processInstanceId}
            , #{taskInstanceId}
            , #{caseId}
            , #{taskStatus}
            , #{taskStartTime}
            , #{taskSuspendTime}
            , #{taskEndTime}
            , TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
            )
    </insert>

    <update id="mergeTbTaskRun" parameterType="kr.go.spo.dto.TaskRunDto">
        MERGE
            INTO tb_task_run A
                USING DUAL
                ON ( A.PROCESS_INSTANCE_ID  = #{processInstanceId}
                    AND A.TASK_INSTANCE_ID  = #{taskInstanceId}
                    )
                WHEN MATCHED THEN
                    UPDATE SET
                          A.task_status  = #{taskStatus}
                    <if test='taskStartTime != null'>
                        , A.task_start_time   = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
                    </if>
                    <if test='taskSuspendTime != null'>
                        , A.task_suspend_time = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
                    </if>
                    <if test='taskEndTime != null'>
                        , A.task_end_time   = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
                    </if>
                        , A.update_time   = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
                WHEN NOT MATCHED THEN
                    INSERT
                        (
                              process_instance_id
                            , task_instance_id
                            , case_id
                            , task_status
                            , task_start_time
                            , task_suspend_time
                            , task_end_time
                            , update_time
                            )
                        VALUES
                            (
                              #{processInstanceId}
                            , #{taskInstanceId}
                            , #{caseId}
                            , #{taskStatus}
                            , #{taskStartTime}
                            , #{taskSuspendTime}
                            , #{taskEndTime}
                            , TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
                            )
    </update>


    <update id="updateTbTaskRun" parameterType="kr.go.spo.dto.TaskRunDto">
        UPDATE tb_task_run
        SET
            task_status       = #{taskStatus}
        <if test='taskStartTime != null'>
            , task_start_time   = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
        </if>
        <if test='taskSuspendTime != null'>
            , task_suspend_time   = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
        </if>
        <if test='taskEndTime != null'>
            , task_end_time   = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
        </if>
            , update_time   = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3')
        WHERE 1=1
          AND process_instance_id = #{processInstanceId}
          AND task_instance_id = #{taskInstanceId}
    </update>






    <insert id="insertTbProcessInstance" parameterType="kr.go.spo.dto.ProcessInstanceDto">
        INSERT INTO TB_PROCESS_INSTANCE
        (
          PROCESS_INSTANCE_ID
        , CASE_ID
        , STATUS
        , START_TIME
        , SUSPEND_TIME
        , END_TIME

        )
        VALUES
            (
              #{processInstanceId}
            , #{caseId}
            , #{status}
            , #{startTime}
            , #{suspendTime}
            , #{endTime}
            )
    </insert>
    <update id="updateTbProcessInstance" parameterType="kr.go.spo.dto.ProcessInstanceDto">
        UPDATE TB_PROCESS_INSTANCE
        SET
        status       = #{status}
        <if test='startTime != null'>
            , start_time   = #{startTime}
        </if>
        <if test='suspendTime != null'>
            , suspend_time   = #{suspendTime}
        </if>
        <if test='endTime != null'>
            , end_time   = #{endTime}
        </if>
        WHERE 1=1
        AND process_instance_id = #{processInstanceId}
    </update>
</mapper>
